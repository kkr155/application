{% extends "base.html" %}
{% block title %}docx{% endblock %}

{% block head %}
{{ super() }}
<meta name="description" content="docx">

<style>
    /* 目录样式 */
    #toc-container {
        position: fixed;
        left: 20px;
        top: 100px;
        width: 250px;
        padding: 15px;
        border-right: 1px solid #ddd;
        overflow-y: auto;
        max-height: 80vh;
    }

    #doc-container {
        margin-left: 20px;
        padding: 20px;
    }

    .toc-item {
        padding: 5px 0;
        cursor: pointer;
        color: #007bff;
    }

    .toc-item:hover {
        text-decoration: underline;
    }

    .chapter-title {
        margin-top: 30px;
        padding-bottom: 10px;
        border-bottom: 2px solid #6c757d;
    }

</style>
{% endblock %}

{% block content %}
<section class="content_text">
    <div id="toc-container"></div>

    <div id="doc-container"></div>
</section>
<script src="https://unpkg.com/mammoth@1.4.16/mammoth.browser.min.js"></script>
<script>
    // 自动加载文档
    async function loadDocx() {
        try {
            const response = await fetch('document.docx');
            if (!response.ok) throw new Error(`HTTP错误: ${response.status}`);

            const arrayBuffer = await response.arrayBuffer();
            const result = await mammoth.convertToHtml({arrayBuffer}, {
                    styleMap: [
                        "u => u", // 下划线
                    ]
                }
            );
            // 处理文档内容
            processDocument(result.value);
        } catch (error) {
            console.error('加载失败:', error);
            document.getElementById('doc-container').innerHTML = `
                <div class="alert alert-danger">
                    文档加载失败: ${error.message}
                </div>
            `;
        }
    }

    // 处理文档内容并生成目录
    function processDocument(html) {
        const docContainer = document.getElementById('doc-container');
        docContainer.innerHTML = html;

        const chapterRegex = /第[一二三四五六七八九十百千零]+章/g;
        const headings = Array.from(docContainer.querySelectorAll('h1, h2, h3, h4, h5, h6, p'))
            .filter(el => chapterRegex.test(el.textContent));

        const tocContainer = document.getElementById('toc-container');
        if (headings.length > 0) {
            tocContainer.innerHTML = '<h4>目录</h4>' +
                headings.map((heading, index) => {
                    const id = `chapter-${index}`;
                    heading.id = id;
                    heading.classList.add('chapter-title');

                    return `<div class="toc-item" onclick="scrollToChapter('${id}')">
                        ${heading.textContent}
                    </div>`;
                }).join('');
        } else {
            tocContainer.innerHTML = '<p>未检测到章节标题</p>';
        }
    }

    function scrollToChapter(id) {
        const element = document.getElementById(id);
        if (element) {
            element.scrollIntoView({behavior: 'smooth'});
            document.querySelectorAll('.chapter-title').forEach(el => {
                el.style.backgroundColor = '';
            });
            element.style.backgroundColor = '#fff3cd';
        }
    }


    window.addEventListener('DOMContentLoaded', loadDocx);
</script>
{% endblock %}
